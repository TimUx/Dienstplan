name: Build, Test and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal
      continue-on-error: true
    
    - name: Get version
      id: version
      run: |
        # Extract version from main project file or use date-based version
        VERSION="1.0.${{ github.run_number }}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version $VERSION"
    
    - name: Publish Windows build
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        dotnet publish src/Dienstplan.Web/Dienstplan.Web.csproj \
          -c Release \
          -r win-x64 \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          -o ./publish/win-x64
    
    - name: Publish Linux build
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        dotnet publish src/Dienstplan.Web/Dienstplan.Web.csproj \
          -c Release \
          -r linux-x64 \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          -o ./publish/linux-x64
    
    - name: Create Windows ZIP
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        cd publish/win-x64
        zip -r ../../Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.zip .
        cd ../..
    
    - name: Create Linux TAR.GZ
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        cd publish/linux-x64
        tar -czf ../../Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}.tar.gz .
        cd ../..
    
    - name: Generate changelog
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## Changes in this release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        git log --pretty=format:"- %s (%h)" -10 >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body: |
          # Dienstplan Release v${{ steps.version.outputs.VERSION }}
          
          Automatisch generiertes Release vom Build-System.
          
          ## ðŸ“¦ Downloads
          - **Windows**: Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.zip
          - **Linux**: Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}.tar.gz
          
          ## ðŸš€ Installation
          
          ### Windows
          1. Download und entpacken Sie die ZIP-Datei
          2. FÃ¼hren Sie `Dienstplan.Web.exe` aus
          3. Ã–ffnen Sie einen Browser und navigieren Sie zu `http://localhost:5000`
          
          ### Linux
          ```bash
          tar -xzf Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}.tar.gz
          chmod +x Dienstplan.Web
          ./Dienstplan.Web
          ```
          
          ${{ steps.changelog.outputs.CHANGELOG }}
        files: |
          Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.zip
          Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
