name: Build, Test and Release

on:
  workflow_dispatch:

jobs:
  build-python-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create production database
      run: |
        mkdir -p data
        python db_init.py data/dienstplan.db
    
    - name: Test Python modules
      run: |
        python -c "import ortools; print('OR-Tools:', ortools.__version__)"
        python -c "import flask; print('Flask:', flask.__version__)"
    
    - name: Get version
      id: version
      run: |
        # Extract version from main project file or use date-based version
        $VERSION = "2.0.${{ github.run_number }}"
        echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
        echo "Building version $VERSION"
    
    - name: Build Windows executable with PyInstaller
      run: |
        python -m PyInstaller Dienstplan.spec
    
    - name: Prepare Windows release
      run: |
        mkdir release
        Copy-Item dist\Dienstplan.exe release\
        Copy-Item -Recurse data release\
        Copy-Item README.md release\
        Copy-Item LICENSE release\
        echo "Dienstplan v${{ steps.version.outputs.VERSION }}" > release\VERSION.txt
        echo "" >> release\VERSION.txt
        echo "To start the application:" >> release\VERSION.txt
        echo "1. Double-click Dienstplan.exe" >> release\VERSION.txt
        echo "2. The web browser will open automatically" >> release\VERSION.txt
        echo "3. Default URL: http://localhost:5000" >> release\VERSION.txt
        echo "" >> release\VERSION.txt
        echo "Database Location: data\dienstplan.db" >> release\VERSION.txt
        echo "The database is persistent and will retain all your data." >> release\VERSION.txt
        echo "" >> release\VERSION.txt
        echo "Default Login:" >> release\VERSION.txt
        echo "  Email: admin@fritzwinter.de" >> release\VERSION.txt
        echo "  Password: Admin123!" >> release\VERSION.txt
        echo "  IMPORTANT: Change the password after first login!" >> release\VERSION.txt
        echo "" >> release\VERSION.txt
        echo "No Python installation required!" >> release\VERSION.txt
    
    - name: Create Windows ZIP
      run: |
        Compress-Archive -Path release\* -DestinationPath Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.zip
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $env:GITHUB_OUTPUT
        echo "## Changes in this release" >> $env:GITHUB_OUTPUT
        echo "" >> $env:GITHUB_OUTPUT
        try {
          git log --pretty=format:"- %s (%h)" -10 >> $env:GITHUB_OUTPUT
        } catch {
          echo "- Initial release" >> $env:GITHUB_OUTPUT
        }
        echo "" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body: |
          # Dienstplan Release v${{ steps.version.outputs.VERSION }}
          
          **Version 2.0 - Python Edition mit standalone Windows executable**
          
          ## üì¶ Downloads
          - **Windows**: Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.zip (keine Python-Installation erforderlich!)
          
          ## üöÄ Installation & Verwendung
          
          ### Windows (Standalone Executable - Empfohlen!)
          1. Download und entpacken Sie die ZIP-Datei
          2. Doppelklicken Sie auf `Dienstplan.exe`
          3. Das Programm startet automatisch den Webserver und √∂ffnet Ihren Browser
          4. Standard-URL: `http://localhost:5000`
          
          **Keine Installation von Python oder anderen Abh√§ngigkeiten erforderlich!**
          
          ### Datenbank
          - **Speicherort**: `data/dienstplan.db`
          - **Persistenz**: Die Datenbank ist persistent und beh√§lt alle Ihre Daten
          - **Standard-Login**:
            - E-Mail: `admin@fritzwinter.de`
            - Passwort: `Admin123!`
            - ‚ö†Ô∏è **WICHTIG**: √Ñndern Sie das Passwort nach der ersten Anmeldung!
          
          ### Alternative: Python (f√ºr alle Betriebssysteme)
          Falls Sie Python bereits installiert haben oder eine andere Plattform verwenden:
          ```bash
          pip install -r requirements.txt
          python main.py init-db
          python main.py serve
          ```
          
          ## ‚ú® Features
          - ‚úÖ Standalone Windows Executable (keine Abh√§ngigkeiten)
          - ‚úÖ Produktionsf√§hige, persistente SQLite-Datenbank
          - ‚úÖ Automatischer Start des Webservers
          - ‚úÖ Automatisches √ñffnen des Browsers
          - ‚úÖ Google OR-Tools f√ºr optimale Schichtplanung
          - ‚úÖ Responsive Web-UI f√ºr Desktop & Mobile
          - ‚úÖ Vollst√§ndige Benutzerverwaltung mit Rollen
          
          ${{ steps.changelog.outputs.CHANGELOG }}
        files: |
          Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
