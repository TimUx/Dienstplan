name: Build, Test and Release

on:
  workflow_dispatch:

jobs:
  build-python-windows-empty:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test Python modules
      run: |
        python -c "import importlib.metadata; print('OR-Tools:', importlib.metadata.version('ortools'))"
        python -c "import importlib.metadata; print('Flask:', importlib.metadata.version('flask'))"
        python -c "import importlib.metadata; print('Waitress:', importlib.metadata.version('waitress'))"
    
    - name: Get version
      id: version
      run: |
        $VERSION = "2.1.${{ github.run_number }}"
        echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
        echo "Building version $VERSION (Production - Empty Database)"
    
    - name: Build Windows executable with PyInstaller
      run: |
        python -m PyInstaller Dienstplan.spec
    
    - name: Rename executable with version
      run: |
        Move-Item dist\Dienstplan.exe Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.exe
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable-empty
        path: Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.exe

  build-python-linux-empty:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test Python modules
      run: |
        python -c "import importlib.metadata; print('OR-Tools:', importlib.metadata.version('ortools'))"
        python -c "import importlib.metadata; print('Flask:', importlib.metadata.version('flask'))"
        python -c "import importlib.metadata; print('Waitress:', importlib.metadata.version('waitress'))"
    
    - name: Get version
      id: version
      run: |
        VERSION="2.1.${{ github.run_number }}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version $VERSION (Production - Empty Database)"
    
    - name: Build Linux executable with PyInstaller
      run: |
        python -m PyInstaller Dienstplan.spec
    
    - name: Rename executable with version
      run: |
        mv dist/Dienstplan Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}
        chmod +x Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}
    
    - name: Upload Linux executable
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable-empty
        path: Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}

  create-release:
    needs: [build-python-windows-empty, build-python-linux-empty]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version
      id: version
      run: |
        VERSION="2.1.${{ github.run_number }}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version $VERSION"
    
    - name: Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: windows-executable-empty
    
    - name: Download Linux executable
      uses: actions/download-artifact@v4
      with:
        name: linux-executable-empty
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## Changes in this release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        git log --pretty=format:"- %s (%h)" -10 >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body: |
          # Dienstplan Release v${{ steps.version.outputs.VERSION }}
          
          **Version 2.1 - Python Edition - Production Release**
          
          ## üì¶ Downloads
          
          Download the executable for your platform:
          - **Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.exe** - Windows Executable
          - **Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}** - Linux Binary
          
          ## ‚ú® What's New
          
          - ‚úÖ **Production-ready**: Uses Waitress WSGI server (no development warnings)
          - ‚úÖ **Clean installation**: Database created automatically on first run
          - ‚úÖ **No bundled data**: Empty database initialized dynamically
          - ‚úÖ **Standalone executables**: No Python or dependencies required
          - ‚úÖ **Single file release**: Just the executable, no additional files needed
          
          ## üöÄ Quick Start
          
          ### Windows
          1. Download **Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.exe**
          2. Double-click to run
          3. Browser opens automatically at http://localhost:5000
          4. Database is created in `data/dienstplan.db` (same directory as executable)
          
          ### Linux
          ```bash
          # Download the executable
          wget https://github.com/TimUx/Dienstplan/releases/download/v${{ steps.version.outputs.VERSION }}/Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}
          
          # Make it executable
          chmod +x Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}
          
          # Run it
          ./Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}
          ```
          
          Database is created in `data/dienstplan.db` (same directory as executable)
          
          ## üîê Default Login
          
          - **Email**: admin@fritzwinter.de
          - **Password**: Admin123!
          - ‚ö†Ô∏è **IMPORTANT**: Change password after first login!
          
          ## üìù Database Location
          
          - The database is automatically created in: `data/dienstplan.db`
          - Located in the same directory as the executable
          - Fully persistent - all your data is saved
          - Empty on first run - ready for production use
          
          ## üõ†Ô∏è Technical Details
          
          - **Web Server**: Waitress (production WSGI server)
          - **Solver**: Google OR-Tools CP-SAT
          - **Database**: SQLite (automatically initialized)
          - **No Python needed**: All dependencies bundled
          
          ${{ steps.changelog.outputs.CHANGELOG }}
        files: |
          Dienstplan-Windows-v${{ steps.version.outputs.VERSION }}.exe
          Dienstplan-Linux-v${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
